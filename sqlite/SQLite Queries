


--create cleaned data structures from old (unformatted tables)
create table cleaned_MenuPages as  select mp.* from menupages mp inner join cleaned_menu cm on cm.id = mp.menu_id; 
create table cleaned_MenuItems as  select mi.* from menuitems mi inner join menupages mp on mi.menu_page_id = mp.id inner join cleaned_menu cm on cm.id = mp.menu_id; 
create table cleaned_Dishes as select * from Dishes;
create table cleaned_Menu as select * from Menu;

--add foreign keys (via UI)

--load cleaned_menu from cleaned menu dataset
--add foreign keys (via UI)

--FK menuPages.menu_id --> menu.id
--FK menuItems --> menuPages.id
--FK MenuItems.dish_id --> dishes.id



--row counts of raw sets
select count(*) from menu;
select count(*) from menupages;
select count(*) from menuitems;

-- row counts of cleaned sets
select count(*) from cleaned_menu;
select count(*) from cleaned_menupages;
select count(*) from cleaned_menuitems;


-- ic violations from original raw datasets
select * from menupages mp left join menu m on mp.menu_id = m.id where m.id is NULL;   -- 5736 ic violations in Menupages
select count(*) from menuitems mi left join menupages mp on mi.menu_page_id = mp.id where mp.id is NULL; -- 0 ic violations in menuitems related to menupages
select count(*) from menuitems mi left join dishes d on mi.dish_id= d.id where d.id is NULL; --244 ic violations in menuitems related to dishes


--////DATA CLEANING DIAGNOSTICS////

select count(*) from cleaned_menupages; --count of rows left in menupages after removing ic violations
select count(*) from cleaned_menuItems; -- count of rows left in menuitems after removing foreign key violations
select count(*) from cleaned_dishes; -- dishes is a parent table and has no violations



--//////// IC/foreign key violations summary/////////////

--menupages  --66937, 16704, 50233
select 
count (*) as original_menupages_rowcount,
(select count(*) from cleaned_menupages) as cleaned_menupages_rowcount,
((select count(*) from menupages) - (select count(*) from cleaned_menupages)) as num_ic_violations_removed
from menupages;


--menuitems   --1335255, 866797, 468458
select 
count (*) as original_menuitems_rowcount,
(select count(*) from cleaned_menuitems) as cleaned_menuitems_rowcount,
((select count(*) from menuitems) - (select count(*) from cleaned_menuitems)) as num_ic_violations_removed
from menuitems;



--rows removed from cleaning menu (not ic violations)    --17562,5532,12030
select 
count (*) as original_menu_rowcount,
(select count(*) from cleaned_menu) as cleaned_menu_rowcount,
((select count(*) from menu) - (select count(*) from cleaned_menu)) as num_ic_violations_removed
from menu;


-- alternate check of ic violations verification using original tables and new cleaned menus
select 
(select count(*) from menuitems) as original_mi_rows,
  count(*) as remaining_cleaned_menuitems_rows,  
((select count(*) from menuitems) - count(*)) as IC_violations_Menuitems
from menuitems mi inner join menupages mp on mi.menu_page_id = mp.id inner join cleaned_menu cm on cm.id = mp.menu_id; --1335255, 866797, 468458

select 
(select count(*) from menupages) as original_mp_rows,
  count(*) as remaining_cleaned_mp_rows,  
((select count(*) from menupages) - count(*)) as IC_violations_Menuitems
from menupages mp inner join cleaned_menu cm on cm.id = mp.menu_id;  --66937, 16704, 50233


select 
(select count(*) from menu) as original_menu_rows,
  count(*) as remaining_cleaned_menu_rows,  
((select count(*) from menu) - count(*)) as IC_violations_Menu
from cleaned_menu; --17562,5532,12030


--////CLEANING DIAGNOSTICS/////////


--rows removed due to currency being dollars and locations outside US
select * from menu m left join cleaned_menu cm on m.id = cm.id
where m.currency ='Dollars' and cm.id is null;


--ALTERNATE CHECK
/*select count(*) as original_menu_dollar_currency_count, 
(select count(*) from cleaned_menu where currency = 'Dollars') as cleaned_menu_dollar_currency_count,
 (count(*) - (select count(*) from cleaned_menu where currency = 'Dollars')) as difference
from menu where currency = 'Dollars';*/




-- row changes to location
select m.id, m.place as menu_original_place, cm.place_cleaned as cleaned_menu_place_label from menu m left join cleaned_menu cm on m.id = cm.id
where m.place != cm.place_cleaned;


-- QUERIES

-- 
--Average price by dollar and year
select 
    date_year_cleaned, 
    currency, 
    avg(price)
from 
    cleaned_menu m
    inner join
    cleaned_menupages mp on m.id = mp.menu_id
    inner join
    cleaned_menuitems mi on mp.Id = mi.menu_page_id
where 
    currency = 'Dollars' 
group by 
    date_year_cleaned,
    currency
order by 
    currency, 
    date_year_cleaned
;

--avg price by year and city,state
select 
    date_year_cleaned,
    place_cleaned,
    currency, 
    avg(price)
from 
    cleaned_menu m
    inner join
    cleaned_menupages mp on m.id = mp.menu_id
    inner join
    cleaned_menuitems mi on mp.Id = mi.menu_page_id
where 
    currency = 'Dollars' 
group by 
    date_year_cleaned,
    place_cleaned,
    currency
order by 
    currency, 
    place_cleaned,
    date_year_cleaned
;


select
--    SUBSTRING(place_cleaned, 1, INSTR(place_cleaned, ',') - 1) as city,
    case when place_cleaned = '' then 'UNKNOWN' else SUBSTRING(place_cleaned, INSTR(place_cleaned, ',')+1) end as state_place,
    date_year_cleaned,
    currency, 
    avg(price)
from 
    cleaned_menu m
    inner join
    cleaned_menupages mp on m.id = mp.menu_id
    inner join
    cleaned_menuitems mi on mp.Id = mi.menu_page_id
where 
    currency = 'Dollars' 
    and
    date_year_cleaned != ''
group by
    state_place,
    date_year_cleaned,
    place_cleaned,
    currency
order by
    state_place,
    date_year_cleaned, 
    currency, 
    place_cleaned

;
